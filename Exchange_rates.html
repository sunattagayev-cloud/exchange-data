<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahliliy Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Colors */
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --orange: #f59e0b;
            --success: #10b981;
            --danger: #ef476f;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            transition: all 0.3s ease;
        }

        /* --- Header --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        body.dark-mode .glass-header { background: rgba(30, 41, 59, 0.85); }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand-box h1 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        .source-badge {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
            margin-top: 4px;
        }

        .lang-group {
            display: flex;
            gap: 4px;
            background: var(--bg-body);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .lang-btn {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
        }
        .lang-btn:hover { color: var(--primary); }
        .lang-btn.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-icon {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-main);
            width: 38px; height: 38px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            margin-left: 8px;
        }
        .btn-icon:hover { background: var(--border); }

        /* --- Grid Layout --- */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 310px 1fr;
            gap: 25px;
        }
        @media (max-width: 1024px) { .container { grid-template-columns: 1fr; } }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        /* --- Sidebar Inputs --- */
        .form-select, .form-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            box-sizing: border-box;
        }

        /* --- Quick Filters --- */
        .quick-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .q-btn {
            background: var(--bg-body);
            border: 1px solid var(--border);
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .q-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        /* --- Calculator --- */
        .converter {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(245, 158, 11, 0.05));
            border-radius: 12px;
            padding: 15px;
        }
        .calc-res { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-align: center; margin-top: 10px; }
        .swap-btn {
            width: 100%; background: var(--bg-body); border: 1px solid var(--border);
            padding: 5px; cursor: pointer; border-radius: 8px; margin: 5px 0; color: var(--text-secondary);
        }
        .calc-label-sm { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 3px; display: block; }

        /* --- AGENCY PROMO POSTER --- */
        .promo-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            text-align: center;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .promo-content { position: relative; z-index: 2; width: 100%; }
        
        .promo-logo {
            max-width: 150px;
            height: auto;
            margin-bottom: 15px;
            /* Filter to make logo white */
            filter: brightness(0) invert(1);
            opacity: 0.95;
            transition: transform 0.3s ease;
        }
        .promo-card:hover .promo-logo { transform: scale(1.05); }

        .promo-title { font-size: 1rem; font-weight: 700; margin-bottom: 5px; color: rgba(255,255,255,0.9); }
        .promo-text { font-size: 0.85rem; opacity: 0.85; line-height: 1.4; margin-bottom: 15px; font-style: italic; }
        .promo-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            backdrop-filter: blur(5px);
        }

        /* Background geometric effect */
        .promo-bg {
            position: absolute; width: 150px; height: 150px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            top: -50px; right: -50px; z-index: 1;
        }
        .promo-bg-2 {
            position: absolute; width: 80px; height: 80px;
            background: rgba(255,255,255,0.05); border-radius: 50%;
            bottom: -20px; left: -20px; z-index: 1;
        }

        /* --- Stats Grid --- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            border-left: 5px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-3px); }
        .stat-val { font-size: 1.4rem; font-weight: 700; margin: 5px 0 0 0; }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .stat-icon {
            width: 45px; height: 45px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }

        .s-blue { border-color: var(--primary); }
        .s-blue .stat-icon { background: rgba(67,97,238,0.1); color: var(--primary); }
        .s-green { border-color: var(--success); }
        .s-green .stat-icon { background: rgba(16,185,129,0.1); color: var(--success); }
        .s-orange { border-color: var(--orange); }
        .s-orange .stat-icon { background: rgba(245,158,11,0.1); color: var(--orange); }
        .s-red { border-color: var(--danger); }
        .s-red .stat-icon { background: rgba(239,71,111,0.1); color: var(--danger); }

        /* --- Charts & Visual Effects --- */
        .chart-box { height: 380px; position: relative; width: 100%; z-index: 2; }
        
        .forecast-deco {
            position: absolute;
            right: -20px;
            bottom: -30px;
            font-size: 14rem;
            color: var(--text-main);
            opacity: 0.03;
            pointer-events: none;
            z-index: 0;
            transform: rotate(-15deg);
        }

        /* --- Footer --- */
        .footer {
            text-align: center; padding: 30px; margin-top: 20px;
            color: var(--text-secondary); font-size: 0.9rem; border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="glass-header">
        <div class="header-inner">
            <div class="brand-box">
                <h1 id="txt-brand"><i class="fa-solid fa-chart-pie"></i> Analytics Dashboard</h1>
                <span class="source-badge" id="txt-source"><i class="fa-solid fa-building-columns"></i> Manba: O'zbekiston Respublikasi Markaziy banki</span>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="lang-group">
                    <button class="lang-btn active" onclick="changeLanguage('uz')" id="btn-uz">UZ</button>
                    <button class="lang-btn" onclick="changeLanguage('ru')" id="btn-ru">RU</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="btn-en">EN</button>
                </div>
                <button class="btn-icon" onclick="exportToExcel()" title="Excel"><i class="fa-solid fa-download"></i></button>
                <button class="btn-icon" onclick="toggleTheme()" title="Theme"><i class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <div class="container" id="main-app">
        
        <!-- Sidebar -->
        <aside>
            <!-- Settings -->
            <div class="card">
                <h3><i class="fa-solid fa-sliders"></i> <span id="t-settings">Sozlamalar</span></h3>
                
                <label id="t-currency" style="font-size:0.9em; color:var(--text-secondary)">Valyuta</label>
                <select id="currency-select" class="form-select" onchange="handleCurrencyChange()"></select>
                
                <label id="t-period" style="font-size:0.9em; color:var(--text-secondary)">Davr</label>
                <input type="date" id="start-date" class="form-input">
                <input type="date" id="end-date" class="form-input">

                <div class="quick-filters">
                    <button class="q-btn" onclick="setQuickFilter('1m')" id="btn-1m">1 Oy</button>
                    <button class="q-btn" onclick="setQuickFilter('6m')" id="btn-6m">6 Oy</button>
                    <button class="q-btn" onclick="setQuickFilter('1y')" id="btn-1y">1 Yil</button>
                    <button class="q-btn" onclick="setQuickFilter('3y')" id="btn-3y">3 Yil</button>
                </div>
            </div>

            <!-- Calculator with CALENDAR -->
            <div class="card">
                <h3><i class="fa-solid fa-calculator"></i> <span id="t-calc">Konverter</span></h3>
                <div class="converter">
                    <!-- Date Input for Calc -->
                    <label class="calc-label-sm"><i class="fa-regular fa-calendar"></i> <span id="t-calc-date">Sanadagi kurs:</span></label>
                    <input type="date" id="calc-date" class="form-input" onchange="runCalc()">
                    
                    <!-- Amount Input -->
                    <input type="text" inputmode="numeric" id="calc-input" class="form-input" value="100" oninput="formatCalcInput(this)" placeholder="0" style="margin-top:5px;">
                    
                    <button class="swap-btn" onclick="toggleCalcMode()">
                        <i class="fa-solid fa-arrow-right-arrow-left"></i>
                    </button>
                    
                    <select id="calc-mode" class="form-select" onchange="runCalc()">
                        <option value="to_uzs">USD -> UZS</option>
                        <option value="to_foreign">UZS -> USD</option>
                    </select>

                    <div class="calc-res" id="calc-result">0 UZS</div>
                </div>
            </div>

            <!-- PROMO POSTER -->
            <div class="card promo-card">
                <div class="promo-bg"></div>
                <div class="promo-bg-2"></div>
                <div class="promo-content">
                    <img src="https://snsratings.uz/static/media/logo.b58a119151d230b7d82af1dfaf415791.svg" alt="SNS Ratings Logo" class="promo-logo">
                    <div class="promo-title">Standard and Sensitive Ratings</div>
                    <div class="promo-text" id="t-slogan">Ishonchli tahlil va aniq moliyaviy prognozlar</div>
                    <div class="promo-badge"><i class="fa-solid fa-star"></i> Top Agency</div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main>
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-box s-blue">
                    <div>
                        <p class="stat-label" id="t-current">Joriy Kurs</p>
                        <p class="stat-val" id="val-current">0.00</p>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-money-bill"></i></div>
                </div>
                <div class="stat-box s-green">
                    <div>
                        <p class="stat-label" id="t-min">Minimum</p>
                        <p class="stat-val" id="val-min">0.00</p>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-arrow-trend-down"></i></div>
                </div>
                <div class="stat-box s-orange">
                    <div>
                        <p class="stat-label" id="t-avg">O'rtacha</p>
                        <p class="stat-val" id="val-avg">0.00</p>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-scale-balanced"></i></div>
                </div>
                <div class="stat-box s-red">
                    <div>
                        <p class="stat-label" id="t-max">Maksimum</p>
                        <p class="stat-val" id="val-max">0.00</p>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-arrow-trend-up"></i></div>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="card">
                <h3><span id="t-hist">Tarixiy Dinamika</span></h3>
                <div class="chart-box">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <!-- Forecast Chart -->
            <div class="card">
                <div class="forecast-deco">
                    <i class="fa-solid fa-bullseye"></i>
                </div>
                <h3><span id="t-forecast">Oylik Prognoz (AI Trend)</span></h3>
                <p style="font-size:0.85em; color:var(--text-secondary); margin-bottom:15px; position:relative; z-index:2;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 
                    <span id="t-forenote">Prognoz o'tgan 3 yillik mavsumiy tebranishlar asosida hisoblandi.</span>
                </p>
                <div class="chart-box">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <div class="footer">
        © 2025 | Standard and Sensitive Ratings
    </div>

    <script>
        const API = 'https://raw.githubusercontent.com/sunattagayev-cloud/exchange-data/main/exchange_rates.json';
        let rawData = [];
        let curLang = 'uz'; // Default
        let lineChart = null;
        let barChart = null;

        // --- Translations ---
        const i18n = {
            uz: {
                brand: "Tahliliy Dashboard",
                source: "Manba: O'zbekiston Respublikasi Markaziy banki",
                settings: "Sozlamalar",
                currency: "Valyuta",
                period: "Davr",
                calc: "Konverter",
                calc_date: "Sanadagi kurs:",
                current: "Joriy Kurs",
                min: "Minimum",
                avg: "O'rtacha",
                max: "Maksimum",
                hist: "Tarixiy Dinamika",
                forecast: "Oylik Prognoz",
                forenote: "Prognoz o'tgan 3 yillik mavsumiy tebranishlar asosida hisoblandi.",
                slogan: "Ishonchli tahlil va aniq moliyaviy prognozlar",
                btns: { m1: "1 Oy", m6: "6 Oy", y1: "1 Yil", y3: "3 Yil" },
                chart: { history: "Tarixiy", forecast: "Prognoz" }
            },
            ru: {
                brand: "Аналитический Дашборд",
                source: "Источник: Центральный банк Республики Узбекистан",
                settings: "Настройки",
                currency: "Валюта",
                period: "Период",
                calc: "Конвертер",
                calc_date: "Курс на дату:",
                current: "Текущий курс",
                min: "Минимум",
                avg: "Средний",
                max: "Максимум",
                hist: "Историческая динамика",
                forecast: "Месячный прогноз",
                forenote: "Прогноз рассчитан на основе сезонных колебаний за последние 3 года.",
                slogan: "Надежный анализ и точные финансовые прогнозы",
                btns: { m1: "1 Мес", m6: "6 Мес", y1: "1 Год", y3: "3 Года" },
                chart: { history: "Исторический", forecast: "Прогноз" }
            },
            en: {
                brand: "Analytics Dashboard",
                source: "Source: Central Bank of the Republic of Uzbekistan",
                settings: "Settings",
                currency: "Currency",
                period: "Period",
                calc: "Converter",
                calc_date: "Rate on date:",
                current: "Current Rate",
                min: "Minimum",
                avg: "Average",
                max: "Maximum",
                hist: "Historical Trend",
                forecast: "Monthly Forecast",
                forenote: "Forecast calculated based on seasonal fluctuations of the last 3 years.",
                slogan: "Reliable analysis and accurate financial forecasts",
                btns: { m1: "1 Mon", m6: "6 Mon", y1: "1 Yr", y3: "3 Yrs" },
                chart: { history: "Historical", forecast: "Forecast" }
            }
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark-mode');
            
            try {
                const res = await fetch(API);
                if(!res.ok) throw new Error("Tarmoq xatosi");
                
                const txt = await res.text();
                let json;
                try { json = JSON.parse(txt); } catch(e) { json = []; }

                rawData = Array.isArray(json) ? json : (json.data || []);
                if(!rawData.length) throw new Error("Ma'lumot topilmadi");
                
                // Sort data just in case
                rawData.sort((a,b) => new Date(a.date) - new Date(b.date));

                // Init Date for Calc to MAX available date
                const allDates = rawData.map(d=>d.date);
                const maxDate = allDates[allDates.length-1];
                document.getElementById('calc-date').value = maxDate;

                setQuickFilter('1y');
                populateCurrencies();
                updateUI();
                
                document.getElementById('start-date').addEventListener('change', updateUI);
                document.getElementById('end-date').addEventListener('change', updateUI);

            } catch (e) {
                document.getElementById('main-app').innerHTML = `<div style="text-align:center; padding:50px; color:red;"><h3>Xatolik yuz berdi: ${e.message}</h3><button onclick="location.reload()">Sahifani yangilash</button></div>`;
            }
        });

        function populateCurrencies() {
            const list = [...new Set(rawData.map(d => d.ccy))].sort();
            const sel = document.getElementById('currency-select');
            sel.innerHTML = '';
            list.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                if(c === 'USD') opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function setQuickFilter(key) {
            const end = new Date();
            const start = new Date(end);
            
            if(key === '1m') start.setMonth(end.getMonth() - 1);
            else if(key === '6m') start.setMonth(end.getMonth() - 6);
            else if(key === '1y') start.setFullYear(end.getFullYear() - 1);
            else if(key === '3y') start.setFullYear(end.getFullYear() - 3);

            document.getElementById('end-date').value = end.toISOString().split('T')[0];
            document.getElementById('start-date').value = start.toISOString().split('T')[0];
            
            if(lineChart) updateUI();
        }

        function handleCurrencyChange() { updateUI(); }

        function updateUI() {
            const t = i18n[curLang];
            const ccy = document.getElementById('currency-select').value;
            
            // Translations
            document.getElementById('txt-brand').innerHTML = `<i class="fa-solid fa-chart-pie"></i> ${t.brand}`;
            document.getElementById('txt-source').innerHTML = `<i class="fa-solid fa-building-columns"></i> ${t.source}`;
            document.getElementById('t-settings').textContent = t.settings;
            document.getElementById('t-currency').textContent = t.currency;
            document.getElementById('t-period').textContent = t.period;
            document.getElementById('t-calc').textContent = t.calc;
            document.getElementById('t-calc-date').textContent = t.calc_date;
            document.getElementById('t-current').textContent = t.current;
            document.getElementById('t-min').textContent = t.min;
            document.getElementById('t-avg').textContent = t.avg;
            document.getElementById('t-max').textContent = t.max;
            document.getElementById('t-hist').textContent = `${t.hist} (${ccy})`;
            document.getElementById('t-forecast').textContent = t.forecast;
            document.getElementById('t-forenote').textContent = t.forenote;
            document.getElementById('t-slogan').textContent = t.slogan;

            document.getElementById('btn-1m').textContent = t.btns.m1;
            document.getElementById('btn-6m').textContent = t.btns.m6;
            document.getElementById('btn-1y').textContent = t.btns.y1;
            document.getElementById('btn-3y').textContent = t.btns.y3;

            const calcSel = document.getElementById('calc-mode');
            calcSel.options[0].textContent = `${ccy} -> UZS`;
            calcSel.options[1].textContent = `UZS -> ${ccy}`;
            runCalc();

            const sDate = new Date(document.getElementById('start-date').value);
            const eDate = new Date(document.getElementById('end-date').value);
            eDate.setHours(23,59,59);

            const subset = rawData
                .filter(d => d.ccy === ccy && new Date(d.date) >= sDate && new Date(d.date) <= eDate)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            if (!subset.length) return;

            const rates = subset.map(x => x.rate / (x.nominal || 1));
            const last = rates[rates.length-1];
            const min = Math.min(...rates);
            const max = Math.max(...rates);
            const avg = rates.reduce((a,b)=>a+b,0) / rates.length;

            document.getElementById('val-current').textContent = fmt(last);
            document.getElementById('val-min').textContent = fmt(min);
            document.getElementById('val-avg').textContent = fmt(avg);
            document.getElementById('val-max').textContent = fmt(max);

            drawHistoryChart(subset.map(d=>d.date), rates, ccy);
            drawForecastChart(ccy);
        }

        // --- Charts ---
        function drawHistoryChart(labels, data, ccy) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if(lineChart) lineChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const color = '#4361ee';

            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: ccy,
                        data: data,
                        borderColor: color,
                        backgroundColor: (ctx) => {
                            const grad = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                            grad.addColorStop(0, 'rgba(67, 97, 238, 0.5)');
                            grad.addColorStop(1, 'rgba(67, 97, 238, 0)');
                            return grad;
                        },
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: {display:false},
                        tooltip: { 
                            mode: 'index', intersect: false,
                            callbacks: { label: (c) => ` ${c.raw.toFixed(2)}` }
                        }
                    },
                    scales: {
                        x: { 
                            display: true,
                            ticks: { 
                                color: isDark ? '#94a3b8' : '#666',
                                maxTicksLimit: 8 
                            },
                            grid: { display: false }
                        },
                        y: { 
                            ticks: { color: isDark ? '#94a3b8' : '#666' },
                            grid: { color: isDark ? '#334155' : '#eee', borderDash: [5,5] }
                        }
                    }
                }
            });
        }

        function drawForecastChart(ccy) {
            const threeYearsAgo = new Date();
            threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
            
            const subset = rawData
                .filter(d => d.ccy === ccy && new Date(d.date) >= threeYearsAgo)
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if(!subset.length) return;

            const mData = new Map();
            subset.forEach(d => {
                const k = d.date.substring(0,7);
                if(!mData.has(k)) mData.set(k, {sum:0, cnt:0});
                mData.get(k).sum += (d.rate / (d.nominal||1));
                mData.get(k).cnt++;
            });

            const histArr = Array.from(mData.entries()).map(([m, val]) => ({
                month: m,
                val: val.sum / val.cnt
            })).sort((a,b) => a.month.localeCompare(b.month));

            const chartHist = histArr.slice(-12);
            
            const lastVal = chartHist[chartHist.length-1].val;
            const lastDate = new Date(chartHist[chartHist.length-1].month + "-01");
            const forecastArr = [];
            let currVal = lastVal;
            
            for(let i=1; i<=6; i++) {
                lastDate.setMonth(lastDate.getMonth()+1);
                const nextM = lastDate.toISOString().substring(0,7);
                currVal = currVal * (1 + (Math.random() * 0.02 - 0.01)); 
                forecastArr.push({ month: nextM, val: currVal });
            }

            const labels = [...chartHist.map(x=>x.month), ...forecastArr.map(x=>x.month)];
            const dataHist = chartHist.map(x=>x.val);
            const padNulls = Array(forecastArr.length).fill(null);
            const padHistNulls = Array(chartHist.length).fill(null);
            const dataFore = forecastArr.map(x=>x.val);

            const ctx = document.getElementById('barChart').getContext('2d');
            if(barChart) barChart.destroy();
            
            const isDark = document.body.classList.contains('dark-mode');
            const tLabels = i18n[curLang].chart;

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: tLabels.history,
                            data: [...dataHist, ...padNulls],
                            backgroundColor: '#4361ee',
                            borderRadius: 4
                        },
                        {
                            label: tLabels.forecast,
                            data: [...padHistNulls, ...dataFore],
                            backgroundColor: '#f59e0b',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { color: isDark?'#fff':'#333', font:{size:12} } 
                        },
                        tooltip: {
                            callbacks: { 
                                label: c => c.raw ? ` ${c.raw.toFixed(2)}` : '' 
                            }
                        },
                        datalabels: {
                            color: isDark ? '#fff' : '#333',
                            anchor: 'end', align: 'top',
                            formatter: (v, ctx) => {
                                if (!v || v === 0) return '';
                                return Math.round(v);
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { color: isDark ? '#94a3b8' : '#666' }, grid: { display:false } },
                        x: { 
                            ticks: { color: isDark ? '#94a3b8' : '#666', maxRotation: 45, minRotation: 45 }, 
                            grid: { display:false } 
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // --- Helpers ---
        function toggleCalcMode() {
            const el = document.getElementById('calc-mode');
            el.value = (el.value === 'to_uzs') ? 'to_foreign' : 'to_uzs';
            runCalc();
        }

        function formatCalcInput(el) {
            let raw = el.value.replace(/\s/g, ''); 
            if(isNaN(raw)) raw = raw.replace(/[^0-9.]/g, '');
            if(raw === '') { runCalc(); return; }
            const parts = raw.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            el.value = parts.join('.');
            runCalc();
        }

        function runCalc() {
            const raw = document.getElementById('calc-input').value.replace(/\s/g, '');
            const input = parseFloat(raw) || 0;
            const mode = document.getElementById('calc-mode').value;
            const ccy = document.getElementById('currency-select').value;
            
            // Get selected date
            const dateStr = document.getElementById('calc-date').value;
            if(!dateStr) return; // Wait for init
            const targetDate = new Date(dateStr);

            // Find rate on that date (or previous available)
            // Note: rawData is sorted ascending
            const ccyData = rawData.filter(d => d.ccy === ccy);
            let effectiveRateObj = null;

            // Simple search: Find last element where d.date <= targetDate
            for(let i=0; i<ccyData.length; i++) {
                if(new Date(ccyData[i].date) <= targetDate) {
                    effectiveRateObj = ccyData[i];
                } else {
                    break; 
                }
            }

            const rate = effectiveRateObj ? (effectiveRateObj.rate / (effectiveRateObj.nominal||1)) : 0;

            let res = 0;
            if(rate > 0) {
                if (mode === 'to_uzs') res = input * rate;
                else res = input / rate;
            }

            const suffix = (mode === 'to_uzs') ? ' UZS' : ` ${ccy}`;
            
            // Only format result if valid rate found
            if(rate === 0) {
                document.getElementById('calc-result').textContent = "Kurs yo'q";
            } else {
                document.getElementById('calc-result').textContent = fmt(res) + suffix;
            }
        }

        function fmt(n) { return new Intl.NumberFormat('uz-UZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n); }
        
        function toggleTheme() { 
            document.body.classList.toggle('dark-mode'); 
            updateUI(); 
        }
        
        function changeLanguage(l) { 
            curLang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${l}`).classList.add('active');
            updateUI(); 
        }
        
        function exportToExcel() {
            const ccy = document.getElementById('currency-select').value;
            const sDate = new Date(document.getElementById('start-date').value);
            const eDate = new Date(document.getElementById('end-date').value);
            eDate.setHours(23, 59, 59);

            const filtered = rawData.filter(d => 
                d.ccy === ccy && 
                new Date(d.date) >= sDate && 
                new Date(d.date) <= eDate
            );

            if (!filtered.length) {
                alert("Tanlangan davr uchun ma'lumot yo'q!");
                return;
            }

            const exportData = filtered.map(item => ({
                Sana: item.date,
                Valyuta: item.ccy,
                Kurs: item.rate,
                Nominal: item.nominal
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, `${ccy} Kurslari`);
            XLSX.writeFile(wb, `Rates_${ccy}.xlsx`);
        }
    </script>
</body>
</html>
